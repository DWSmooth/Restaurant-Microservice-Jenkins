pipeline {
    agent any
    stages {
        stage("Install Common Library") {
            steps {
                // clone the common library git repo
                sh 'git clone https://github.com/April2022-J-Capstone/Common-Library.git'
                // cd to the common library repo root
                dir("Common-Library") {
                    // switch to common library dev branch
                    sh 'git checkout dev'
                    // maven clean install
                    sh 'mvn clean install'
                    sh 'ls -aoUgh'
                }
            }
        }
        stage("Build Microservice") {
            steps {
                // cd to the main repo package
                dir("restaurant-microservice") {
                    // maven clean package to produce jar
                    sh 'mvn clean package'
                }
            }
        }
        stage("Run Microservice") {
            steps {
                dir("restaurant-microservice/target") {
                    // run microservice
                    sh 'java $(find . -name "*.jar") &>/dev/null &'
                }
            }
        }
    }
    post {
        always {
            sh 'rm -rf Common-Library/'
        }
    }
}